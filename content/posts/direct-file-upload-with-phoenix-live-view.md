---
title: "File Upload to Backblaze or Cloudflare R2 with Phoenix LiveView"
date: 2023-07-29T21:10:12+08:00
draft: true
tag: ["phoenix", "liveview"]
---

Phoenix LiveView has an amazing documentation on implementing direct upload to S3 in
the [official documentation][0]. It works well if you are using AWS S3. However, you might
want to use it with AWS S3 alternatives like Backblaze and Cloudflare R2 that is S3
API compatible.

When attempting to follow the guide above in the Phoenix LiveView documentation, you'll
quickly realize following the steps doesn't end up with a working solution. You'll face
some CORS issue.

Then, you update the CORS configuration in the cloud storage settings and expecting it work.

But it doesn't either.

In this post, I'm going to walk you through the following:

- [Summary](#summary)
    - [Problem](#problem)
    - [Solution](#solution)
- [Step by Step Guide](#step-by-step-guide)

## Summary

The TLDR; version of this is, `POST` with form aren't supported for presigned URL in
some of these AWS S3 alternatives. To resolve it, use a `PUT` instead.

### Problem

Most of the AWS S3 alternatives aren't completely S3 API compatible. While they support
most of the S3 API, there are always some caveats.

In our case, it's because the documentation implement direct upload to S3 through
the `POST` method with native HTML form to a presigned URL, which is currently not
supported in some of the AWS S3 alternatives like Cloudflare R2 and Backblaze.

For Cloudflare R2, the reasoning can be found under the ["Supported HTTP methods" section
of the Cloudflare R2 Presigned URLs][1] documentation:


> ...`POST`, which performs uploads via native HTML forms, is not currently supported.

For Backblaze, while the documentation doesn't point it out explicitly about this, it's actually mentioned
in one of the [ElixirForum dicussion about Backblaze and Phoenix LiveView Uploads][2]:

> ... B2 does not support POST for the S3 PutObject operation.

If we take a look at the S3 Put Object documentation for Backblaze [here][3], it doesn mentioned the
HTTP method supported is `PUT`:

> ...`PUT` https://s3.<your-region>.backblazeb2.com/:bucket/:key

To conclude, it doesn't work because, in the Phoenix LiveView official documentation,
it is using the `POST` method to upload the file directly to AWS S3, which isn't supported.

### Solution

To resolve the above issue, we have to:

- Generate the presigned URL with `PUT` method. In the documentation, it's generating a `POST` presigned URL underneath.
- Update the `Uploader` JavaScript implementation to make a `PUT` HTTP requests instead of `POST` with form.

Now, these information should be sufficient for you to resolve your bug. If not, you can continue follow
through the below step by step guide.

## Step by Step Guide

The title would be clickbaity without a full tutorial on implementing direct file upload to
Backblaze and Cloudflare R2 with Phoenix LiveView. So here we go.

This tutorial assumed that you have a fair amount of knowlege with Phoenix LiveView and have
setup one of the AWS S3 alternatives mentioned _(signing up with those services should be fairly
straightforward)_.


### Generate a Phoenix project

Since, we are starting from scratch, let's generate a new Phoenix project.

```bash
mix phx.new gallery
```

After the project is generated, we'll have to run a couple of commands to setup
the project as usual:

```bash
cd gallery
mix ecto.create
```

### Generate the `Image` modal

We are going to use the `Image` modal to associate with our file upload, so let's
generate the basic CRUD with `mix phx.gen.live`:


```bash
mix phx.gen.live Content Image images key:string
mix ecto.migrate
```

and paste the following in your `router.ex`:

```elixir
live "/images", ImageLive.Index, :index
live "/images/new", ImageLive.Index, :new
live "/images/:id/edit", ImageLive.Index, :edit

live "/images/:id", ImageLive.Show, :show
live "/images/:id/show/edit", ImageLive.Show, :edit
```

Now, we can run our application:

```bash
mix phx.server
```

Visit to [localhost:4000/images](http://localhost:4000/images), and we shall see the
basic CRUD generated by Phoenix for our `images` table.

### Direct upload

Now let the real work begin. Let's start with copying the `UploadLive` from
the [Phoenix LiveView Uploads documentation][4]:

```heex
<%!-- lib/gallery_web/live/upload_live.html.heex --%>

<form id="upload-form" phx-submit="save" phx-change="validate">
  <.live_file_input upload={@uploads.avatar} />
  <button type="submit">Upload</button>
</form>

<section phx-drop-target={@uploads.avatar.ref}>

<%= for entry <- @uploads.avatar.entries do %>
  <article class="upload-entry">
    <figure>
      <.live_img_preview entry={entry} />
      <figcaption><%= entry.client_name %></figcaption>
    </figure>

    <progress value={entry.progress} max="100"> <%= entry.progress %>% </progress>
    <button type="button" phx-click="cancel-upload" phx-value-ref={entry.ref} aria-label="cancel">&times;</button>
    <%= for err <- upload_errors(@uploads.avatar, entry) do %>
      <p class="alert alert-danger"><%= error_to_string(err) %></p>
    <% end %>
  </article>
<% end %>

<%= for err <- upload_errors(@uploads.avatar) do %>
  <p class="alert alert-danger"><%= error_to_string(err) %></p>
<% end %>

</section>
```

and

```elixir
# lib/gallery_web/live/upload_live.ex
defmodule GalleryWeb.UploadLive do
  use GalleryWeb, :live_view

  @impl Phoenix.LiveView
  def mount(_params, _session, socket) do
    {:ok,
    socket
    |> assign(:uploaded_files, [])
    |> allow_upload(:avatar, accept: ~w(.jpg .jpeg), max_entries: 2)}
  end

  @impl Phoenix.LiveView
  def handle_event("validate", _params, socket) do
    {:noreply, socket}
  end

  @impl Phoenix.LiveView
  def handle_event("cancel-upload", %{"ref" => ref}, socket) do
    {:noreply, cancel_upload(socket, :avatar, ref)}
  end

  @impl Phoenix.LiveView
  def handle_event("save", _params, socket) do
    uploaded_files =
      consume_uploaded_entries(socket, :avatar, fn %{path: path}, _entry ->
        dest = Path.join([:code.priv_dir(:my_app), "static", "uploads", Path.basename(path)])
        File.cp!(path, dest)
        {:ok, ~p"/uploads/#{Path.basename(dest)}"}
      end)

    {:noreply, update(socket, :uploaded_files, &(&1 ++ uploaded_files))}
  end

  defp error_to_string(:too_large), do: "Too large"
  defp error_to_string(:too_many_files), do: "You have selected too many files"
  defp error_to_string(:not_accepted), do: "You have selected an unacceptable file type"
end
```








[0]: https://hexdocs.pm/phoenix_live_view/uploads-external.html
[1]: https://developers.cloudflare.com/r2/api/s3/presigned-urls/#supported-http-methods
[2]: https://elixirforum.com/t/backblaze-and-phoenix-liveview-uploads/57153/8
[3]: https://www.backblaze.com/apidocs/s3-put-object
[4]: https://hexdocs.pm/phoenix_live_view/uploads.html
