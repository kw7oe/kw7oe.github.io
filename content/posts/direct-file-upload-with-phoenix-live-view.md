---
title: "File Upload to Backblaze or Cloudflare R2 with Phoenix LiveView"
date: 2023-07-29T21:10:12+08:00
draft: true
tag: ["phoenix", "liveview"]
---

The title would be clickbaity without a full tutorial on implementing direct file upload to
Backblaze and Cloudflare R2 with Phoenix LiveView. So here we go.

This tutorial assumed that you have a fair amount of knowlege with Phoenix LiveView and have
setup one of the AWS S3 alternatives mentioned _(signing up with those services should be fairly
straightforward)_.


### Generate a Phoenix project

Since, we are starting from scratch, let's generate a new Phoenix project.

```bash
mix phx.new gallery
```

After the project is generated, we'll have to run a couple of commands to setup
the project as usual:

```bash
cd gallery
mix ecto.create
```

### Generate the `Image` modal

We are going to use the `Image` modal to associate with our file upload, so let's
generate the basic CRUD with `mix phx.gen.live`:


```bash
mix phx.gen.live Content Image images key:string
mix ecto.migrate
```

and paste the following in your `router.ex`:

```elixir
live "/images", ImageLive.Index, :index
live "/images/new", ImageLive.Index, :new
live "/images/:id/edit", ImageLive.Index, :edit

live "/images/:id", ImageLive.Show, :show
live "/images/:id/show/edit", ImageLive.Show, :edit
```

Now, we can run our application:

```bash
mix phx.server
```

Visit to [localhost:4000/images](http://localhost:4000/images), and we shall see the
basic CRUD generated by Phoenix for our `images` table.

### Direct upload

Now let the real work begin. Let's start with copying the `UploadLive` from
the [Phoenix LiveView Uploads documentation][0]:

```html
<h1 class="text-2xl font-bold mb-4">Upload Images</h1>

<form id="upload-form" phx-submit="save" phx-change="validate">
  <div class="space-y-8 divide-y divide-gray-200 sm:space-y-5">
    <div class="sm:grid sm:border-t sm:border-gray-200 sm:pt-5 mx-auto">
      <section class="mt-1 sm:mt-0" phx-drop-target={@uploads.avatar.ref}>
        <div class="grid grid-cols-4 gap-4 mb-4">
          <%= for entry <- @uploads.avatar.entries do %>
            <article class="upload-entry">
              <figure>
                <.live_img_preview entry={entry} />
                <figcaption><%= entry.client_name %></figcaption>
              </figure>

              <progress value={entry.progress} max="100"><%= entry.progress %>%</progress>

              <button
                type="button"
                phx-click="cancel-upload"
                phx-value-ref={entry.ref}
                aria-label="cancel"
              >
                &times;
              </button>

              <%= for err <- upload_errors(@uploads.avatar, entry) do %>
                <p class="alert alert-danger"><%= error_to_string(err) %></p>
              <% end %>
            </article>
          <% end %>
        </div>

        <%= for err <- upload_errors(@uploads.avatar) do %>
          <p class="alert alert-danger"><%= error_to_string(err) %></p>
        <% end %>

        <div class="flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
          <div class="space-y-1 text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
              aria-hidden="true"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
              </path>
            </svg>

            <div class="flex text-sm text-gray-600">
              <p class="pl-1">Drag and drop your images here</p>
            </div>
            <p class="text-xs text-gray-500">
              Photos up to 20MB
            </p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="mt-4">
    <p class="mb-4">or</p>
    <.live_file_input upload={@uploads.avatar} />
    <.button class="mt-4 float-right">Upload</.button>
  </div>
</form>
```

and

```elixir
# lib/gallery_web/live/upload_live.ex
defmodule GalleryWeb.UploadLive do
  use GalleryWeb, :live_view

  @impl Phoenix.LiveView
  def mount(_params, _session, socket) do
    {:ok,
     socket
     |> assign(:uploaded_files, [])
     |> allow_upload(:avatar, accept: ~w(.jpg .jpeg), max_entries: 2)}
  end

  @impl Phoenix.LiveView
  def handle_event("validate", _params, socket) do
    {:noreply, socket}
  end

  @impl Phoenix.LiveView
  def handle_event("cancel-upload", %{"ref" => ref}, socket) do
    {:noreply, cancel_upload(socket, :avatar, ref)}
  end

  @impl Phoenix.LiveView
  def handle_event("save", _params, socket) do
    uploaded_files =
      consume_uploaded_entries(socket, :avatar, fn %{path: path}, entry ->
        dest =
          Path.join([
            :code.priv_dir(:gallery),
            "static",
            "uploads",
            Path.basename(entry.client_name)
          ])

        File.cp!(path, dest)
        {:ok, ~p"/uploads/#{Path.basename(dest)}"}
      end)

    {:noreply, update(socket, :uploaded_files, &(&1 ++ uploaded_files))}
  end

  defp error_to_string(:too_large), do: "Too large"
  defp error_to_string(:too_many_files), do: "You have selected too many files"
  defp error_to_string(:not_accepted), do: "You have selected an unacceptable file type"
end
```

After copy and pasting these into files, we'll also have to do the following:

1. Create a `priv/static/uploads` directory as our code will be copying the uploaded files
to that directory.
```bash
mkdir priv/static/uploads
```

2. Update the `GalleryWeb.static_path()` function to include `uplaods`:

```elixir
- def static_paths, do: ~w(assets fonts images favicon.ico robots.txt)
+ def static_paths, do: ~w(assets fonts images uploads favicon.ico robots.txt)
```



[0]: https://hexdocs.pm/phoenix_live_view/uploads.html
