<!DOCTYPE html>
<html><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
Logging Thread ID in Rust | kw7oe
</title>



<meta name="generator" content="Hugo 0.98.0" />





  
  <link rel="stylesheet" href="https://kaiwern.com/css/styles.min.da6e1927bcb6a0faebcb06ab9925c87524b8057860afacf48eab54fcbf9eef18.css" integrity="sha256-2m4ZJ7y2oPrrywarmSXIdSS4BXhgr6z0jqtU/L+e7xg=">
  <script async defer data-domain="kaiwern.com" src="https://plausible.io/js/plausible.js"></script>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">


<body class="flex flex-col min-h-screen px-6 max-w-prose md:w-2/3 m-auto"><nav class="mt-8">
  <ul id="nav-menu" class="w-full flex items-center list-reset">
    
    <li>
      <a href="https://kaiwern.com/">Home</a>
    </li>
    

    
    <li>
      <a href="https://kaiwern.com/fragments/">Fragments</a>
    </li>
    

    


    
    <li>
      <a href="https://kaiwern.com/about/">About</a>
    </li>
    

    
    <li>
      <a href="https://kaiwern.com/tags/">Tags</a>
    </li>
    


    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</nav>


    <main class="flex-1 mt-10 sm:mt-12">
<div>
  <header class="mb-8 font-sans-serif">
    
    <div class="text-sm font-gray-700 mb-8">
      <p class="uppercase font-semibold">
      <a class="text-gray-700" href="/fragments">fragments</a>
      </p>
      <p>May 07, 2022</p>
    </div>
    

    <h1 class="text-3xl mb-1 font-semibold">Logging Thread ID in Rust</h1>
    
      <p class="italic text-xs">Last updated at: May 27, 2022</p>
    
  </header>

  <article class="prose serif mb-16 text-gray-800">
    <p>Recently, I am working on implementing concurrent operations for B+ Tree
index in Rust. Dealing with concurrency bugs can be pain in the ass and
and being able to print the thread ID along with by my debug message definitely
help me understand the interleaving operations better.</p>
<p>Here&rsquo;s how I learn to do it using <a href="#env-logger">env_logger</a> crate and <a href="#tracing">tracing</a> crate.</p>
<h3 id="env-logger">Env Logger</h3>
<p>I was using <a href="https://docs.rs/env_logger/latest/env_logger/"><code>env_logger</code></a> to
log my message. Upon realizing that <code>std::thread::current()</code> allow me to get
the information of the current thread executing my code, and it have the <code>id()</code>
method, I start to inject the info into my log as needed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">current</span><span class="p">().</span><span class="n">id</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{}: fetch page {page_id}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>Soon, I realize that I can format the log records by default
using the <code>Builder::format</code> method. So I ended up with this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Write</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">env_logger</span>::<span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="o">|</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">timestamp_micros</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">writeln!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">buf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;{}: {:?}: {}: {}&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ts</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">std</span>::<span class="n">thread</span>::<span class="n">current</span><span class="p">().</span><span class="n">id</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">buf</span><span class="p">.</span><span class="n">default_level_style</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">record</span><span class="p">.</span><span class="n">args</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="n">init</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>which will log my message in the following format:</p>
<pre tabindex="0"><code>2022-05-07T07:26:33.119900Z: ThreadId(7): INFO: fetch page 1
</code></pre><h3 id="tracing">Tracing</h3>
<p>Later on, I switch to using <a href="https://github.com/tokio-rs/tracing"><code>tracing</code></a>
and the setup is much simpler as follow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">tracing_subscriber</span>::<span class="n">fmt</span><span class="p">().</span><span class="n">with_thread_ids</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="n">init</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>It turns out <code>tracing_subscriber</code> formatter come with the <code>with_thread_ids</code>
method to include your thread id in your logs once set to <code>true</code>. Here&rsquo;s
how the messsage look like:</p>
<pre tabindex="0"><code>May 07 15:38:42.197  INFO ThreadId(01) sqlite::table::test: fetch page 1
</code></pre><p>There are more configuration methods that might be useful for you such as <code>with_thread_names</code>,
so do have a look at the
<a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/fmt/struct.SubscriberBuilder.html">documentation</a>!</p>


    <div class="float-right mb-8">
      <p class="text-sm mb-4 font-gray-700 italic">(222 words)</p>
    </div>
  </article>

</div>

    </main>




<hr/>
<footer class="w-full text-center p-4 pin-b text-xs text-gray-400">
    <p>made with <a href="https://gohugo.io" class="underline hover:text-blue-400">Hugo</a> and <a href="https://tailwindcss.com" class="underline hover:text-blue-400">TailwindCSS</a></p>
</footer>
</body>
</html>
