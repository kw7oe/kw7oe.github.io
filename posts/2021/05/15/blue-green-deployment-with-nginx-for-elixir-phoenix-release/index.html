<!DOCTYPE html>
<html><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
Blue Green Deployment with Nginx for Elixir/Phoenix Release | kw7oe
</title>



<meta name="generator" content="Hugo 0.98.0" />





  
  <link rel="stylesheet" href="https://kaiwern.com/css/styles.min.dac98e0d40206aac10ee672374f9e62dc5ab71b0d1358edae64fdcff3a3f50e6.css" integrity="sha256-2smODUAgaqwQ7mcjdPnmLcWrcbDRNY7a5k/c/zo/UOY=">
  <script async defer data-domain="kaiwern.com" src="https://plausible.io/js/plausible.js"></script>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">

<body class="flex flex-col min-h-screen px-6 max-w-prose md:w-2/3 m-auto"><nav class="mt-8">
  <ul id="nav-menu" class="w-full flex items-center list-reset">
    
    <li>
      <a href="https://kaiwern.com/">Home</a>
    </li>
    

    
    <li>
      <a href="https://kaiwern.com/fragments/">Fragments</a>
    </li>
    

    


    
    <li>
      <a href="https://kaiwern.com/about/">About</a>
    </li>
    

    
    <li>
      <a href="https://kaiwern.com/tags/">Tags</a>
    </li>
    


    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</nav>

    

    <main class="flex-1 mt-10 sm:mt-12">
<header class="mb-8 font-sans-serif">
  <div class="text-sm font-gray-700 mb-8">
      <p class="uppercase font-semibold">
      <a class="text-gray-700" href="/posts">posts</a>
      </p>
      <p>May 15, 2021</p>
  </div>

  <h1 class="title mb-2">Blue Green Deployment with Nginx for Elixir/Phoenix Release</h1>
  <p class="text-sm font-gray-700 mb-4 italic">Estimated Reading Time: 20 minutes (4207 words) </p>

   
  <div id="tags">
    
    
    
    <span class="badge badge-primary rounded-badge">
      <a href="https://kaiwern.com/tags/elixir/">elixir</a>
    </span>
    
    
    
    
    <span class="badge badge-primary rounded-badge">
      <a href="https://kaiwern.com/tags/phoenix/">phoenix</a>
    </span>
    
    
    
    
    <span class="badge badge-primary rounded-badge">
      <a href="https://kaiwern.com/tags/deployment/">deployment</a>
    </span>
    
    
    
    
    <span class="badge badge-primary rounded-badge">
      <a href="https://kaiwern.com/tags/nginx/">nginx</a>
    </span>
    
    
    
    
    <span class="badge badge-primary rounded-badge">
      <a href="https://kaiwern.com/tags/tutorial/">tutorial</a>
    </span>
    
    
  </div>
</header>

<article class="prose serif mb-12 text-gray-800">
  

  <p>In this post today, I&rsquo;ll share about how I setup blue green deployment for my
Phoenix application using <code>nginx</code> <em>running on a single machine</em>. This post is
made possible thanks to this article about <a href="https://www.kimsereylam.com/gitlab/nginx/dotnetcore/ubuntu/2019/01/04/custom-blue-green-deployment-with-nginx-and-gitlab-ci.html">Custom Blue Green Deployment with Nginx
And Gitlab CI</a>.</p>
<p>The core idea to make blue green deployment possible for Elixir releases with
<code>nginx</code> is through:</p>
<ul>
<li>Running two releases at the same time in your remote server.</li>
<li>Switching traffic to new release through linking to a different <code>nginx</code>
configuration to <code>/site-enabled</code> and reload <code>nginx</code>.</li>
</ul>
<p>This approach is only suitable for smaller scale system or hobby
projects. I have never operate any serious production system with this setup.
Hence, I&rsquo;ll advise you to offload this to something more battle tested for
your real world high traffic production sytem.</p>
<p><em>While this article is written specifically for Elixir/Phoenix deployment,
similar approach and scripts can apply for any web application running behind
nginx to achieve blue green deployment.</em></p>
<h3 id="table-of-content">Table of Content</h3>
<ul>
<li><a href="#prerequisite">Prerequisite</a></li>
<li><a href="#following-along">Following Along</a></li>
<li><a href="#setting-up-nginx">Setting Up <code>nginx</code></a></li>
<li><a href="#running-two-copies-of-our-application">Running two copies of our apllication</a></li>
<li><a href="#promoting-our-green-version-to-live">Promoting our green version to live</a></li>
<li><a href="#running-migration-and-console">Running migration and console</a></li>
<li><a href="#deploying-new-blue-and-green-version">Deploying new blue and green version</a></li>
<li><a href="#glue-it-all-together">Glue it all together</a></li>
<li><a href="#wrap-up">Wrap Up</a></li>
</ul>
<h2 id="prerequisite">Prerequisite</h2>
<p>Before we begin, this post assume you know how to:</p>
<ul>
<li>Configure Elixir/Phoenix application for production release</li>
<li>Setup nginx on production machine to be used as a reverse proxy to direct traffic to our application.</li>
<li>Build and deploy your Elixir/Phoenix application</li>
</ul>
<p>This post also reused majority of the <code>bash</code> script that I have written in the
previous blog posts about <a href="https://kaiwern.com/posts/2020/06/20/building-elixir/phoenix-release-with-docker/">building</a> and <a href="https://kaiwern.com/posts/2020/07/20/deploying-elixir/phoenix-release-to-production/">deploying Elixir releases</a> <em>(with some changes to
cater the needs to make blue green deployment happen)</em>.</p>
<h2 id="following-along">Following Along</h2>
<p>While writing this post, I have gone through a few iteration to setting up and
down the environment with Vagrant. So if you are interested to follow along with it or
experiment it locally, you can use the
<a href="https://github.com/kw7oe/phoenix-bg-sample-app">repository</a>.</p>
<p>The README in the repository will contain more details on the required setup
to follow along in this article.</p>
<h2 id="setting-up-nginx">Setting Up <code>nginx</code></h2>
<p>Before we go into details on how we can setup our Blue Green deployment, it&rsquo;s
important for us to understand the building blocks that make it possible. Let&rsquo;s
start with understanding how <code>nginx</code> can help us with that.</p>
<p><img src="/images/nginx-bg-deployment.png" alt="Blue Green Deployment with nginx architecturediagram"></p>
<figcaption class="mb-4 italic text-center">Using nginx for Blue Green Deployment</figcaption>
<p>Basically:</p>
<ul>
<li>we use nginx as a reverse proxy to forward requests received from
internet to our application process.</li>
<li>nginx forward the traffic differently
based on our configuration at <code>/etc/nginx/site-enabled/domain.app</code>.</li>
<li>which are symlinked with <code>/etc/nginx/site-available/{blue,green}</code>.</li>
<li>Each configuration file tell nginx to direct the traffic to the blue/green
version of our application process at different port.</li>
</ul>
<p>Let&rsquo;s setup our nginx as above.</p>
<h3 id="blue-nginx-configuration">Blue Nginx Configuration</h3>
<p>Let&rsquo;s start by writing our blue <em>(also our initial)</em> nginx configuration file
<em>(<a href="https://hexdocs.pm/phoenix/1.3.0-rc.1/phoenix_behind_proxy.html">refer from Phoenix Documentation</a>)</em> and placed it
under <code>/etc/nginx/sites-available/blue</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">upstream</span> <span class="s">phoenix-blue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Assuming your application is running on PORT 4000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">4000</span> <span class="s">max_fails=5</span> <span class="s">fail_timeout=60s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kn">server_name</span> <span class="s">domain.app</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kn">location</span> <span class="s">/deployment_id</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">return</span> <span class="mi">200</span> <span class="s">&#34;blue&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">allow</span> <span class="s">all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Proxy Headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">X-Cluster-Client-Ip</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The Important Websocket Bits!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;upgrade&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_pass</span> <span class="s">http://phoenix-blue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We are putting it in <code>sites-available</code> instead of <code>sites-enabled</code> because as
demonstrated above,  we would need to symlink different configuration file to
our domain. Now we can symlink our configuration file to <code>sites-enabled</code>
with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo ln -sf /etc/nginx/sites-available/blue /etc/nginx/sites-enabled/domain.app
</span></span></code></pre></div><p>then, we can reload our nginx services to have it use our updated
configuration:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl reload nginx
</span></span></code></pre></div><p>In your machine, <code>curl domain.app/deployment_id</code>, you should see a <code>blue</code> text as a
result.</p>
<p>Assuming you have your application process listening to port 400, visiting to
<code>domain.app</code> will display your application correctly.</p>
<p>We have now setup the blue version of nginx for our application. Let&rsquo;s
proceed to setup the green version next!</p>
<div class="callout callout-info">
  <p class="font-bold">I don't own domain.app. How can I curl that?</p>
  <p>
    To do that, you can modify your <code>/etc/hosts</code> file
    in your local machine. <em>(Or any equivalent file/configuration in
    Windows)</em>
  </p>
  <p>
    Here is how my hosts file looks like in my local machine,
    where I'm poiting <code>domain.app</code> to the local IP of my Vagrant VM.
  </p>
  <div class="highlight"><pre class="chroma"><code><span>192.168.33.40 domain.app</span></code></pre>
  </div>
  <p>
    This work because by default, our local machine will first hit
    <code>/etc/hosts</code> to get the hostnames to IP address mapping before
    hitting any DNS.
  </p>
</div>
<h3 id="green-nginx-configuration">Green Nginx configuration</h3>
<p>To be able to blue green deploy, we would need another nginx configuration that
point to our green application process. It would look very similar with the
blue version configuration with some minor changes as follow in
<code>/etc/nginx/sites-available/green</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="c1"># Define another upstream and point to a different PORT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">upstream</span> <span class="s">phoenix-green</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Assuming your &#39;green&#39; application is running on PORT 5000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">5000</span> <span class="s">max_fails=5</span> <span class="s">fail_timeout=60s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kn">server_name</span> <span class="s">domain.app</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Return &#39;green&#39; instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kn">location</span> <span class="s">/deployment_id</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">return</span> <span class="mi">200</span> <span class="s">&#34;green&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">allow</span> <span class="s">all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Proxy Headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">X-Cluster-Client-Ip</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The Important Websocket Bits!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;upgrade&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Point to our upstream defined above.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">proxy_pass</span> <span class="s">http://phoenix-green</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>To <em>promote</em> our green application to live, is to symlink
it to be used as our domain configuration with the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo ln -sf /etc/nginx/sites-available/green /etc/nginx/sites-enabled/domain.app
</span></span></code></pre></div><p>follow by reloading our nginx service configuration:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl reload nginx
</span></span></code></pre></div><p><code>curl domain.app/deployment_id</code> and you&rsquo;ll see a <code>green</code>
text returned.  However, if you try to visit <code>domain.app</code> and visit
other path of your application, you might get a 502 Bad Gateway.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">╰─➤  curl domain.app/deployment_id
</span></span><span class="line"><span class="cl">green%
</span></span><span class="line"><span class="cl">╭─kai at KW.local ~/Desktop/mini-hackathon/life ‹1.11.3-otp-23› ‹main*›
</span></span><span class="line"><span class="cl">╰─➤  curl domain.app/health
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
</span></span><span class="line"><span class="cl">&lt;hr&gt;&lt;center&gt;nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>&lt;/center&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>That&rsquo;s because we
haven&rsquo;t run any copy of our application on port <code>5000</code> yet as specified in
our <code>nginx</code> configuration.</p>
<p>Let&rsquo;s revert our changes here by promoting our blue
version to live at this moment first:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ln -sf /etc/nginx/sites-available/blue /etc/nginx/sites-enabled/domain.app
</span></span><span class="line"><span class="cl">sudo systemctl reload nginx
</span></span></code></pre></div><p>We will be <a href="#promoting-our-green-version-to-live">promoting our green version to
live</a> after we run the green copy of
our application successfully.</p>
<div class="callout callout-info">
  <p class="font-bold">Getting Not Found</p>
  <p>
    If you curl and get `Not Found`, try removing the default nginx config
    which are <code>/etc/nginx/sites-available/default</code> and
    <code>/etc/nginx/sites-enabled/default</code>. Then, try again.
  </p>
</div>
<h2 id="running-two-copies-of-our-application">Running two copies of our application</h2>
<p>Since we have been relying on environment variable for our port value, to
deploy another copy of our application on a different port, should be as
simple as changing the <code>PORT</code> value right?</p>
<p>So, all we need to do is to just update part of our bash script to
conditionally deploy our release with different ports! Easy. So, here&rsquo;s what we
got:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$deploy_version</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=4000 ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=5000 ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>But, how do we know about our current live version?</p>
<p>Remember that <code>/deployment_id</code> in our nginx configuration? That&rsquo;s how we can
get our current live version:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;https://domain.app/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;green&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The previous bash script</span>
</span></span><span class="line"><span class="cl"><span class="c1"># continue here...</span>
</span></span></code></pre></div><p>We are done right? Not quite. If we run our deploy script and go into our
server and check with <code>lsof</code> <em>(list open file description)</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ lsof -i :5000
</span></span><span class="line"><span class="cl"><span class="c1">#=&gt; empty result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ lsof -i :4000
</span></span><span class="line"><span class="cl">COMMAND   PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span class="line"><span class="cl">beam.smp <span class="m">5162</span> vagrant   20u  IPv6  <span class="m">39660</span>      0t0  TCP *:4000 <span class="o">(</span>LISTEN<span class="o">)</span>
</span></span></code></pre></div><p>You&rsquo;ll see that our application release doesn&rsquo;t get started successfully.</p>
<h3 id="run-multiple-copies-of-same-elixir-release-in-a-single-server">Run multiple copies of same Elixir release in a single server</h3>
<p>Let&rsquo;s attempt to start it manually and see what actually happen:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">source</span> .env <span class="o">&amp;&amp;</span> <span class="nv">PORT</span><span class="o">=</span><span class="m">5000</span> &lt;app_version&gt;/bin/&lt;app_name&gt; start
</span></span><span class="line"><span class="cl">Protocol <span class="s1">&#39;inet_tcp&#39;</span>: the name &lt;app_name&gt;@&lt;hostname&gt; seems to be in use by another Erlang node
</span></span></code></pre></div><p>Seems like it failed to start.</p>
<p>What is this error about? Well everytime, our release is started, a default
node name is actually provided according to our application name. Furthermore, in a
single server, we can&rsquo;t have two same release running with the same node name.</p>
<p>You can replicate the above behaviour easily in your local machine by
running the following in two different terminals:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iex --cookie <span class="m">1234</span> --sname apple
</span></span></code></pre></div><p>which will result in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># In terminal one</span>
</span></span><span class="line"><span class="cl">╰─➤  iex --cookie <span class="m">1234</span> --sname apple
</span></span><span class="line"><span class="cl">Erlang/OTP <span class="m">23</span> <span class="o">[</span>erts-11.1.1<span class="o">]</span> <span class="o">[</span>source<span class="o">]</span> <span class="o">[</span>64-bit<span class="o">]</span> <span class="o">[</span>smp:4:4<span class="o">]</span> <span class="o">[</span>ds:4:4:10<span class="o">]</span> <span class="o">[</span>async-threads:1<span class="o">]</span> <span class="o">[</span>hipe<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Interactive Elixir <span class="o">(</span>1.11.3<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type</span> h<span class="o">()</span> ENTER <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">iex<span class="o">(</span>apple@KW<span class="o">)</span>1&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># In terminal two</span>
</span></span><span class="line"><span class="cl">╰─➤  iex --cookie <span class="m">1234</span> --sname apple
</span></span><span class="line"><span class="cl">Protocol <span class="s1">&#39;inet_tcp&#39;</span>: the name apple@KW seems to be in use by another Erlang node
</span></span></code></pre></div><p>To resolve this, we need to specify a different node name when starting our
release:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">source</span> .env <span class="o">&amp;&amp;</span> <span class="nv">PORT</span><span class="o">=</span><span class="m">5000</span> <span class="nv">RELEASE_NODE</span><span class="o">=</span>green &lt;app_version&gt;/bin/&lt;app_name&gt; start
</span></span><span class="line"><span class="cl">15:46:40.449 <span class="o">[</span>info<span class="o">]</span> Running Web.Endpoint with cowboy 2.8.0 at :::5000 <span class="o">(</span>http<span class="o">)</span>
</span></span><span class="line"><span class="cl">15:46:40.450 <span class="o">[</span>info<span class="o">]</span> Access Web.Endpoint at http://example.com
</span></span></code></pre></div><h3 id="bash-script-for-deploying-multiple-elixir-releases">Bash script for deploying multiple Elixir releases</h3>
<p>At this point, this is how our <code>./deploy.sh</code> script looks like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s1">&#39;app:&#39;</span> mix.exs <span class="p">|</span> sed -e <span class="s1">&#39;s/\[//g&#39;</span> -e <span class="s1">&#39;s/ //g&#39;</span> -e <span class="s1">&#39;s/app://&#39;</span> -e <span class="s1">&#39;s/[:,]//g&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">APP_VSN</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s1">&#39;version:&#39;</span> mix.exs <span class="p">|</span> cut -d <span class="s1">&#39;&#34;&#39;</span> -f2<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">TAR_FILENAME</span><span class="o">=</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span>-<span class="si">${</span><span class="nv">APP_VSN</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl"><span class="c1"># I&#39;m using vagrant to run and test locally,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># can be replaced by your remote server ip and user.</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOST</span><span class="o">=</span><span class="s2">&#34;vagrant@192.168.33.40&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bold_echo<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -e <span class="s2">&#34;\033[1m---&gt; </span><span class="nv">$1</span><span class="s2">\033[0m&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">build_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Building Docker images...&#34;</span>
</span></span><span class="line"><span class="cl">  docker build -t app .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Extracting release tar file...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">ID</span><span class="o">=</span><span class="k">$(</span>docker create app<span class="k">)</span>
</span></span><span class="line"><span class="cl">  docker cp <span class="s2">&#34;</span><span class="nv">$ID</span><span class="s2">:/app/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> .
</span></span><span class="line"><span class="cl">  docker rm <span class="s2">&#34;</span><span class="nv">$ID</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">deploy_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Creating directory if not exist...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> mkdir -p <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Copying environment variables...&#34;</span>
</span></span><span class="line"><span class="cl">  scp .env.production <span class="nv">$HOST</span>:<span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Copying release to remote...&#34;</span>
</span></span><span class="line"><span class="cl">  scp <span class="s2">&#34;</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> <span class="nv">$HOST</span>:<span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Notice that we are extracting the tar file to it respective version</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># folder instead of replacing it at $APP_NAME as previois blog posts.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># The reason of doing so is explained in the section of</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># &#34;Deploying new blue and green version&#34; of this post later on.</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> tar -xzf <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> -C <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  start_release
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Removing remote tar file...&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> rm <span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">start_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;domain.app/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;green&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Starting release ...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$deploy_version</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=4000 ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=5000 RELEASE_NODE=green ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">clean_up<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Removing local tar file...&#34;</span>
</span></span><span class="line"><span class="cl">  rm <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">-&#34;</span>*.tar.gz
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;build&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  build_release
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  build_release
</span></span><span class="line"><span class="cl">  deploy_release
</span></span><span class="line"><span class="cl">  clean_up
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>Running <code>./deploy.sh</code> now the second time <em>(initial green build)</em> will now
deploy another copy of our application with the latest changes. The initial
build will still be running and nothing is impacted.</p>
<h2 id="promoting-our-green-version-to-live">Promoting our green version to live</h2>
<p>The current live version is still blue. So, in order to promote our green
version to live. All we need to do is to run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ln -sf /etc/nginx/sites-available/green /etc/nginx/sites-enabled/domain.app
</span></span><span class="line"><span class="cl">sudo systemctl reload nginx
</span></span></code></pre></div><p>Similar with how we start our release differently, we are going to rely on
<code>/deployment_id</code> to get the current live version and user input to decide which
version we want to promote to live. So here&rsquo;s how the bash script looks like
now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Other code here...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">promote<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Attempting to promote to </span><span class="nv">$1</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2"> is already the live version!&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;green&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">target_nginx_file</span><span class="o">=</span><span class="s2">&#34;green&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">target_nginx_file</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> <span class="s2">&#34;sudo ln -sf /etc/nginx/sites-available/</span><span class="nv">$target_nginx_file</span><span class="s2"> /etc/nginx/sites-enabled/domain.app &amp;&amp; sudo systemctl reload nginx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;build&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  build_release
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;promote&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  promote <span class="nv">$2</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  build_release
</span></span><span class="line"><span class="cl">  deploy_release
</span></span><span class="line"><span class="cl">  clean_up
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>To promote green version to live, all we have to run is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./deploy.sh promote green
</span></span></code></pre></div><p>Now, visiting to <code>domain.app</code> and you shall see your latest changes for your application is live.</p>
<p>Alternatively, if things went wrong and you decided to rollback to blue version, all you need
to run is just:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./deploy.sh promote blue
</span></span></code></pre></div><p>Do note that, at this point, we are running <strong>2 copies of our application</strong> on
our remote server, which means we are consuming twice as much resources as
well.</p>
<h2 id="running-migration-and-console">Running migration and console</h2>
<p>Assuming you have follow the <a href="https://hexdocs.pm/phoenix/releases.html#ecto-migrations-and-custom-commands">guide to setup ecto migration</a> on the official Phoenix Documentation,
you should be able to run migration by running the following comamnd:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">source</span> ~/<span class="nv">$APP_NAME</span>/.env <span class="o">&amp;&amp;</span> ~/<span class="nv">$APP_NAME</span>/<span class="nv">$version</span>/bin/<span class="nv">$APP_NAME</span> <span class="nb">eval</span> <span class="s1">&#39;AppName.Release.migrate()&#39;</span>
</span></span></code></pre></div><p>similarly, to run the remote console is just as simple as:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ~/<span class="nv">$APP_NAME</span>/<span class="nv">$version</span>/bin/<span class="nv">$APP_NAME</span> remote
</span></span></code></pre></div><p>Notice that we don&rsquo;t need to <code>source .env</code> while running <code>remote</code> command
because it is  connecting to our running process.</p>
<p>More details will be cover below.</p>
<h3 id="running-migration">Running migration</h3>
<p>Let&rsquo;s assume we have released both version <code>0.1.0</code> as <code>blue</code> and <code>0.1.1</code> as
<code>green</code>. To run migration for the <code>0.1.0</code> release, it&rsquo;s the same as usual:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">source</span> ~/app_name/.env <span class="o">&amp;&amp;</span> ~/app_name/0.1.0/bin/app_name <span class="nb">eval</span> <span class="s1">&#39;AppName.Release.migrate()&#39;</span>
</span></span></code></pre></div><p>For the latest <code>0.1.1</code> version,
to run the migration is also the same as above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">source</span> ~/app_name/.env <span class="o">&amp;&amp;</span> ~/app_name/0.1.1/bin/app_name <span class="nb">eval</span> <span class="s1">&#39;AppName.Release.migrate()&#39;</span>
</span></span></code></pre></div><p>To simplify things, we can write a bash script to do this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">migrate<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$DOMAIN</span><span class="s2">/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    bold_echo <span class="s2">&#34;Setting blue green version to </span><span class="nv">$LIVE_VERSION</span><span class="s2"> since none specified.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="nv">$LIVE_VERSION</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    bold_echo <span class="s2">&#34;Setting blue green version to </span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$deploy_version</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;green&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;green_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; RELEASE_NODE=green PORT=5000 &#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=4000 &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;blue_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">version</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$version_file</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Running migration for database for release </span><span class="nv">$version</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> eval &#39;AppName.Release.migrate()&#39;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;migrate&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  migrate <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><h3 id="running-remote-console">Running remote console</h3>
<p>Now, let&rsquo;s say that we want to run a remote console on our <code>0.1.0</code> deployed as
<code>blue</code>. It is same as usual:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ~/app_name/0.1.0/bin/app_name remote
</span></span></code></pre></div><p>However, if we want to do the same For the <code>0.1.1</code> version deployed as <code>green</code>,
the following will not work as expected</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ~/app_name/0.1.1/bin/app_name remote
</span></span></code></pre></div><p>and you&rsquo;ll get the following error message complaining that the node is down:</p>
<pre tabindex="0"><code>Erlang/OTP 23 [erts-11.1.8] [source] [64-bit] [smp:2:2] [ds:2:2:10] [async-threads:1] [hipe]

Could not contact remote node app_name@hostname, reason: :nodedown. Aborting...
</code></pre><p>Remember when we spin up our second copy and we specify <code>RELEASE_NODE=green</code>?
It&rsquo;s because of that.</p>
<p>To resolve it, we need to specify our node name explicitly again when running
the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">RELEASE_NODE</span><span class="o">=</span>green ~/app_name/0.1.1/bin/app_name remote
</span></span></code></pre></div><p>And voila, it works!</p>
<h4 id="why-eval-works-without-additional-environment-configuration">Why <code>eval</code> works without additional environment configuration?</h4>
<p>If you run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ~/app_name/0.1.1/bin/app_name
</span></span></code></pre></div><p>You&rsquo;ll get a more detailed description of each command. And if you read about
<code>eval</code>, you&rsquo;ll find that it actually execute the command on a new non booted
system.</p>
<pre tabindex="0"><code>The known commands are:

    ...
    eval &#34;EXPR&#34;    Executes the given expression on a new, non-booted system
    rpc &#34;EXPR&#34;     Executes the given expression remotely on the running system
    remote         Connects to the running system via a remote shell
    ...
</code></pre><p>Hence, unlike <code>remote</code> command that connected to our running system, <code>eval</code> is
not affected as it run on a whole new system.</p>
<p>That also explain why we need to <code>source .env</code> for <code>eval</code> because its running
on another new system.</p>
<h2 id="deploying-new-blue-and-green-version">Deploying new blue and green version</h2>
<p>That&rsquo;s not the end yet. We just cover the initial deployment part so far <em>(the
first two deployments)</em>. Next up, we need to deployed new version for both
<code>blue</code> and <code>green</code> copy of our application.</p>
<p>The main difference between the subsequent and the initial deployment is
that we need to stop our running application before we start the newer version. The script and process is fairly similar to <a href="https://kaiwern.com/posts/2020/07/20/deploying-elixir/phoenix-release-to-production/#2-add-script-to-deploy-new-release">the script to deploy new release in our previous blog post</a></p>
<p>Hence, to deploy our new blue/green version, we need to first stop the old
blue/green version. Once the old process is stop successfully then we can start
the new one.</p>
<p>For example:</p>
<ul>
<li>If live version is green, we will stop old blue version, and start a new one
as blue version. Since we want to ensure zero downtime deployment, hence we
can&rsquo;t be stopping the existing live green version of the application.</li>
<li>If live version is blue, we will stop the old green version.</li>
</ul>
<p>Sounds straightforward right? However, it&rsquo;s not without its own problem.</p>
<h3 id="what-are-the-current-version-running-for-bluegreen-version">What are the current version running for blue/green version?</h3>
<p>Since, we might have 2 application <em>(with different version)</em> running on our
server, we cannot just extract our release into <code>$APP_NAME</code> format as
<a href="https://kaiwern.com/posts/2020/07/20/deploying-elixir/phoenix-release-to-production/#steps-for-initial-release">before</a>.</p>
<p>Instead, we need to extract the release for different version to different
folder in this format <code>$APP_NAME/$APP_VSN</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Old build script</span>
</span></span><span class="line"><span class="cl">ssh <span class="nv">$HOST</span> tar -xzf <span class="nv">$APP_NAME</span>/releases/<span class="nv">$TAR_FILENAME</span> -C <span class="nv">$APP_NAME</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># New build script</span>
</span></span><span class="line"><span class="cl">ssh <span class="nv">$HOST</span> tar -xzf <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> -C <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>which, allow us to run multiple version of our application at the same time.</p>
<p>With this changes, we can stop the running application with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh <span class="nv">$HOST</span> <span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> stop&#34;</span>
</span></span></code></pre></div><p>However, it&rsquo;s not as straightforward as it seems. We still need
to know the current blue/green version our applications are running.</p>
<h3 id="solution">Solution</h3>
<p>To resolve this, we need to get our last deployed blue/green version from
somewhere every time we deploy. There are two ways we can get the version
data:</p>
<ul>
<li>Expose a API endpoint <code>/version</code> to return the running version.</li>
<li>Store our deployed version somewhere in a data store when we deploy</li>
</ul>
<h4 id="using-version">Using <code>/version</code></h4>
<p>We can extract our blue/green running version in our bash script by doing
something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">live_version</span> <span class="o">==</span> <span class="s2">&#34;blue&#34;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">curl</span> <span class="s2">&#34;localhost:5000/version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="n">curl</span> <span class="s2">&#34;localhost:4000/version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>We would need to handle cases where none of blue/green version is deployed before. This can be quite tricky to write in bash.</p>
<p>Technically, I think is still possible to solve it with, <em>&ldquo;if the connection to the server failed, we skip the stopping
phase&rdquo;</em>.</p>
<p>But for now, I&rsquo;ll just leave it to you all if you prefer to do it this way.</p>
<h4 id="store-version-in-a-file">Store version in a file</h4>
<p>Instead, I am going to just write it to a file directly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Deploying to blue with 1.0.0</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 1.0.0 &gt; blue_version.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Deploying to green with 1.0.1</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 1.0.1 &gt; green_version.txt
</span></span></code></pre></div><p>We are using <code>&gt;</code> to overwrite the file instead of appending it.</p>
<p>Alternatively, you can also write it to a object storage like AWS S3 or Google
Cloud Storage.</p>
<p>Since, we are writing to a file here, to check if we have deployed before is as
simple as using bash specific operator to check if a file exist:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f filename <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;filename exist&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><h3 id="bash-script-for-deploying-new-bluegreen-version">Bash script for deploying new blue/green version</h3>
<p>Combining the above, the final bash script for this part
will looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">start_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;domain.app/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;green_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;green&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Since we need to check if our process is running with pid command</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;RELEASE_NODE=green&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;blue_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Check if the file exist.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># If it doesn&#39;t exist, it means that we haven&#39;t deploy</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># the initial version yet.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Hence, we can skip the stopping phase entirely.</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$version_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$version_file</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Don&#39;t exit on error so we can caputure</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> +e
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> pid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      bold_echo <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2"> </span><span class="nv">$version</span><span class="s2"> is not running anymore...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      bold_echo  <span class="s2">&#34;Stopping previous </span><span class="nv">$deploy_version</span><span class="s2">, release </span><span class="nv">$version</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">      ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> stop&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      bold_echo  <span class="s2">&#34;Waiting </span><span class="nv">$deploy_version</span><span class="s2">, release </span><span class="nv">$version</span><span class="s2"> to stop...&#34;</span>
</span></span><span class="line"><span class="cl">      ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> pid&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">1</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">      <span class="k">do</span>
</span></span><span class="line"><span class="cl">        bold_echo  <span class="s2">&#34;Waiting </span><span class="nv">$deploy_version</span><span class="s2">, release </span><span class="nv">$version</span><span class="s2"> to stop...&#34;</span>
</span></span><span class="line"><span class="cl">        ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> pid&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Start Release</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$deploy_version</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=4000 ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env  &amp;&amp; PORT=5000 RELEASE_NODE=green ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Update our version in our version file.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># So that next time, we know this is the version we are currently</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># running</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="nv">$APP_VSN</span> &gt; <span class="nv">$version_file</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="glue-it-all-together">Glue it all together</h2>
<p>Finally, the outcome of it is as follow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Getting your app name from mix.exs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># I probably copy the code from somewhere so...</span>
</span></span><span class="line"><span class="cl"><span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s1">&#39;app:&#39;</span> mix.exs <span class="p">|</span> sed -e <span class="s1">&#39;s/\[//g&#39;</span> -e <span class="s1">&#39;s/ //g&#39;</span> -e <span class="s1">&#39;s/app://&#39;</span> -e <span class="s1">&#39;s/[:,]//g&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">APP_VSN</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s1">&#39;version:&#39;</span> mix.exs <span class="p">|</span> cut -d <span class="s1">&#39;&#34;&#39;</span> -f2<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">TAR_FILENAME</span><span class="o">=</span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span>-<span class="si">${</span><span class="nv">APP_VSN</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># I&#39;m using vagrant to test out the application.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So change this to your own host.</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOST</span><span class="o">=</span><span class="s2">&#34;vagrant@192.168.33.40&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The domain name to curl the blue/green version of your</span>
</span></span><span class="line"><span class="cl"><span class="c1"># service.</span>
</span></span><span class="line"><span class="cl"><span class="nv">DOMAIN</span><span class="o">=</span><span class="s2">&#34;domain.app&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bold_echo<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -e <span class="s2">&#34;\033[1m---&gt; </span><span class="nv">$1</span><span class="s2">\033[0m&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">build_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Building Docker images...&#34;</span>
</span></span><span class="line"><span class="cl">  docker build -t <span class="nv">$APP_NAME</span> .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Extracting release tar file...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">ID</span><span class="o">=</span><span class="k">$(</span>docker create <span class="nv">$APP_NAME</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  docker cp <span class="s2">&#34;</span><span class="nv">$ID</span><span class="s2">:/app/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> .
</span></span><span class="line"><span class="cl">  docker rm <span class="s2">&#34;</span><span class="nv">$ID</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">deploy_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Creating directory if not exist...&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> mkdir -p <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Copying environment variables...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># I&#39;m storing my production environment variable in my local machine</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># and scp it over to the host every time.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Not the recommended way to manage your sercret.</span>
</span></span><span class="line"><span class="cl">  scp .env.production <span class="nv">$HOST</span>:<span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Copying release to remote...&#34;</span>
</span></span><span class="line"><span class="cl">  scp <span class="s2">&#34;</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> <span class="nv">$HOST</span>:<span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> tar -xzf <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span> -C <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  start_release
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Removing remote tar file...&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> rm <span class="s2">&#34;~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$TAR_FILENAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">start_release<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$DOMAIN</span><span class="s2">/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;green_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;green&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Since we need to check if our process is running with pid command</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;RELEASE_NODE=green&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;blue_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Check if the file exist.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># If it doesn&#39;t exist, it means that we haven&#39;t deploy</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># the initial version yet.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Hence, we can skip the stopping phase entirely.</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$version_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$version_file</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Don&#39;t exit on error so we can caputure</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> +e
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> pid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      bold_echo <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2"> </span><span class="nv">$version</span><span class="s2"> is not running anymore...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      bold_echo  <span class="s2">&#34;Stopping previous </span><span class="nv">$deploy_version</span><span class="s2">, release </span><span class="nv">$version</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">      ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> stop&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      bold_echo  <span class="s2">&#34;Waiting </span><span class="nv">$deploy_version</span><span class="s2">, release </span><span class="nv">$version</span><span class="s2"> to stop...&#34;</span>
</span></span><span class="line"><span class="cl">      ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> pid&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">1</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">      <span class="k">do</span>
</span></span><span class="line"><span class="cl">        bold_echo  <span class="s2">&#34;Waiting </span><span class="nv">$deploy_version</span><span class="s2">, release </span><span class="nv">$version</span><span class="s2"> to stop...&#34;</span>
</span></span><span class="line"><span class="cl">        ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> pid&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Start Release</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$deploy_version</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;blue&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=4000 ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$HOST</span> <span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=5000 ELIXIR_ERL_OPTIONS=&#39;-sname green&#39; ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$APP_VSN</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> daemon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Update our version in our version file.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># So that next time, we know this is the version we are currently</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># running</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="nv">$APP_VSN</span> &gt; <span class="nv">$version_file</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">promote<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$DOMAIN</span><span class="s2">/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Attempting to promote to </span><span class="nv">$1</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2"> is already the live version!&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;green&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">target_nginx_file</span><span class="o">=</span><span class="s2">&#34;green&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">target_nginx_file</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> <span class="s2">&#34;sudo ln -sf /etc/nginx/sites-available/</span><span class="nv">$target_nginx_file</span><span class="s2"> /etc/nginx/sites-enabled/</span><span class="nv">$DOMAIN</span><span class="s2"> &amp;&amp; sudo systemctl reload nginx&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$DOMAIN</span><span class="s2">/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Promoted live to </span><span class="nv">$LIVE_VERSION</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">clean_up<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Removing local tar file...&#34;</span>
</span></span><span class="line"><span class="cl">  rm <span class="s2">&#34;</span><span class="nv">$APP_NAME</span><span class="s2">-&#34;</span>*.tar.gz
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">migrate<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LIVE_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s -w <span class="s2">&#34;\n&#34;</span> <span class="s2">&#34;</span><span class="nv">$DOMAIN</span><span class="s2">/deployment_id&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    bold_echo <span class="s2">&#34;Setting blue green version to </span><span class="nv">$LIVE_VERSION</span><span class="s2"> since none specified.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="nv">$LIVE_VERSION</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    bold_echo <span class="s2">&#34;Setting blue green version to </span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">deploy_version</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$deploy_version</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;green&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;green_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; RELEASE_NODE=green PORT=5000 &#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">env</span><span class="o">=</span><span class="s2">&#34;source ~/</span><span class="nv">$APP_NAME</span><span class="s2">/.env &amp;&amp; PORT=4000 &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">version_file</span><span class="o">=</span><span class="s2">&#34;blue_version.txt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">version</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$version_file</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  bold_echo <span class="s2">&#34;Running migration for database for release </span><span class="nv">$version</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ssh <span class="nv">$HOST</span> <span class="s2">&#34;</span><span class="nv">$env</span><span class="s2"> ~/</span><span class="nv">$APP_NAME</span><span class="s2">/</span><span class="nv">$version</span><span class="s2">/bin/</span><span class="nv">$APP_NAME</span><span class="s2"> eval &#39;AppName.Release.migrate()&#39;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;build&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  build_release
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;start&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  start_release
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;promote&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  promote <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;migrate&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  migrate <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  build_release
</span></span><span class="line"><span class="cl">  deploy_release
</span></span><span class="line"><span class="cl">  clean_up
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><h2 id="wrap-up">Wrap Up</h2>
<p>While this blue green deployment works for our simple use case, there are a few
drawbacks that one need to be aware of.</p>
<h3 id="1-every-new-deployment-need-to-have-their-version-bump">1. Every new deployment need to have their version bump.</h3>
<p>Since when we deploy, we are extracting the tar release and overriding the
version folder, everytime we deploy a new code, we need to bump our version so
that older version code <em>(that might be running)</em> won&rsquo;t get replaced.</p>
<p>If you forget to bump your version when deploying new code, weird things might
happen. I haven&rsquo;t find out the possible consequences yet, but will probably
update it here once I have a clearer idea.</p>
<h3 id="2-multiple-nodes">2. Multiple Nodes</h3>
<p>When you scale beyond a single node, while it could work, it becomes
tricky to manage. In theory, you can just loop through and execute the
script separately <em>(or together)</em>. But it becomes tricky when you consider the
possibilities with multiple servers:</p>
<ul>
<li>What if we successfully deploy to server A but fail at server B, C and D?</li>
<li>How do we keep track of different version of our blue/green application on N
different servers?</li>
<li>When you deploy to multiple servers, the next step you might want to consider
is to do rolling release. How would you handle that?</li>
</ul>
<p>As your needs grow, it will feel like you are reinventing the wheels.</p>
<h3 id="3-zero-downtime-for-phoenix-channels">3. Zero downtime for Phoenix Channels</h3>
<p>While we might have zero downtime for our API requests, this setup is not
tested on Phoenix Channels or websockets. In theory, there will be a minimal
downtime.</p>
<p>If you are looking for zero downtime deployment with this method, be sure to do
your own testing.</p>
<h3 id="4-zero-downtime-for-database-migration">4. Zero downtime for Database Migration</h3>
<p>Zero downtime in your application deployment does not mean you&rsquo;ll have zero
downtime service. If you have a database migration that lock your whole table,
you&rsquo;re going to definitely have some downtime <em>(this would be brief if you have a
small dataset)</em>.</p>
<p>So make sure, you understand your system well and the database migration that
you&rsquo;ll be running. I also recommend this <a href="https://www.braintreepayments.com/blog/safe-operations-for-high-volume-postgresql/">blog post</a> from Braintree
regarding safe operations for high volume PostgreSQL if you wish to learn more
regarding this area.</p>
<hr>
<p>Key takeaway here is, it&rsquo;s important to understand different parts of your
systems and how they affect each other. While blue green deployment ensure
minimal downtime for your application process, there are still other subsystems
in your system that will cause your service downtime.</p>
<p>More importantly, it&rsquo;s to understand what do your users of your system care
about. Even <a href="https://sre.google/sre-book/embracing-risk/">Google doesn&rsquo;t strive for 100% uptime</a>.</p>

</article>

    </main>




<hr/>
<footer class="w-full text-center p-4 pin-b text-xs text-gray-400">
    <p>made with <a href="https://gohugo.io" class="underline hover:text-blue-400">Hugo</a> and <a href="https://tailwindcss.com" class="underline hover:text-blue-400">TailwindCSS</a></p>
</footer>
</body>
</html>
